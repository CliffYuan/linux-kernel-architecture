<!DOCTYPE HTML>
<html>
<!-- <html> -->
<head>
  <title>初始化内存管理|Linux Kernel Architecture 内核笔记</title>
  <meta charset="utf-8" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/feed.xml">
<link rel="icon" href="/images/icons/avatar.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/style/css/bootstrap.css" type="text/css" media="screen">
<link rel="stylesheet" href="/style/css/syntax.css" type="text/css" media="screen">
<script type="text/javascript" src="/style/jquery-1.7.1.min.js"></script>


<link rel="stylesheet" href="/style/style.css" type="text/css">

<script>
$(document).ready(function(){
    $('.nav a').hover(
        function(){
            $(this).animate({opacity: 0.3}, 400)
        }, 
        function(){
            $(this).animate({opacity: 1}, 400)
        });
});
function getURLParameter(name) {
    return decodeURI(
        (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]
    );
}
</script>

<style>
.archive li {
    list-style: decimal;
    margin-left: 50px;
    line-height: 2em;
}

.archive .year {
    list-style: none;
}
</style>
  <script type="text/javascript">
        var BYB = {};
  </script>
  <script type="text/javascript">
    BYB.includeScript = function(file,callback){
    var _doc = document.getElementsByTagName('head')[0];
    var js = document.createElement('script');
    js.setAttribute('type', 'text/javascript');
    js.setAttribute('src', file);
    _doc.appendChild(js);
    
    if (!/*@cc_on!@*/0) { //if not IE
    //Firefox2、Firefox3、Safari3.1+、Opera9.6+ support js.onload
    js.onload = function () {
    callback();
    }
    } else {
    //IE6、IE7 support js.onreadystatechange
    js.onreadystatechange = function () {
    if (js.readyState == 'loaded' || js.readyState == 'complete') {
    callback();
    }
    }
    }
    return false;
    }
  </script>
  <meta content="linux kernel architecture 内核笔记 初始化内存管理..." name="description"/>
  <meta content="初始化,内存管理," name="keywords"/>
  <meta property="og:type" content="article" />
  <meta property="og:url" content="http://guojing.me/linux-kernel-architecture//posts/init-mm-management/" />
  <meta property="og:title" content="初始化内存管理" />
  <meta property="og:description" content="linux kernel architecture 内核笔记 初始化内存管理..." />
</head>
<body>

<div class="banner">
<ul class="nav nav-pills">
  <li><a href="/">Home</a></li>
  <li><a href="/archive/">Archive</a></li>
  <li><a href="/linux-kernel-architecture/archive/">Kernel</a></li>
</ul>

</div>

<div class="container">

<div class="main clearfix">
  <div class="title">初始化内存管理</div>

  <div class="content mm_manage内存管理_content_css">
    <p>在内存管理上下文中，初始化（<em>iniitialization</em>）可以有多种含义，在许多CPU上，必须显式设置适用于Linux内核的内存模型，例如在IA-32系统上需要切换到保护模式，然后内核才能检测可用内存和寄存器。在初始化过程中，还必须建立内存管理的数据结构，以及其他很多事物，因为内核在内存管理完全初始化之前就需要使用内存，在系统启动过程期间，使用了一个额外的简化形式的内存管理模块，然后又丢弃掉。</p>

<p>因为内存管理初始化中特定于CPU的部分使用了底层体系结构中许多次要的细节，这些与内核结构没有什么关系。我们只要关心<em>pg_data_t</em>数据结构初始化即可。</p>

<h3 id="nodedata">NODE_DATA</h3>
<p>对相关数据结构的初始化是从全局启动例程<em>start_kernel</em>中开始的，该例程在加载内核并激活各个子系统后执行。由于内存管理是内核的一个非常重要的部分，因此在特定于体系结构的设置步骤中监测内存并确定系统中内存的分配情况后，会立即执行初始化。</p>

<p>所以，已经对各种系统内存模式生成了一个<em>pgdata_t</em>实例，用于保存诸如结点中内存数量以及内存在各个内存域之间的分配情况信息。所有陪你过台上都实现了特定于体系结构的NODE_DATA宏，用来查询与一个NUMA结点相关的<em>pgdata_t</em>实例。</p>

<h4 id="includelinuxmmzoneh">&lt;include/linux/mmzone.h&gt;</h4>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#define NODE_DATA(nid) (&amp;contig_page_data)</span></code></pre></div>

<p>尽管这个宏有一个形式参数用于选择NUMA结点，但在UMA系统只有一个伪结点。所以总是使用相同的数据。</p>

<h3 id="section">系统启动</h3>

<p>系统启动如下图所示：</p>

<p class="center"><img src="/linux-kernel-architecture/images/start_kernel.png" alt="system" style="max-width:400px" /></p>

<p class="center">初始化内存管理流程图</p>

<p>这些函数及其意义分别如下：</p>

<table>
  <thead>
    <tr>
      <th>函数名</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>setup_arch</td>
      <td>这是一个特定于体系结构的函数，其中一项任务是负责初始化自举分配器</td>
    </tr>
    <tr>
      <td>setup_per_cpu_areas</td>
      <td>在SMP系统上，setup_per_cpu_areas初始化源代码中定的静态per-cpu变量，这个变量对系统中的每个CPU都有一个独立的副本，此类变量保存在内核二进制映象的一个独立的段中。这个函数目的是为系统的各个CPU分别创建一份这些数据的副本，在非SMP系统上这个函数是一个空操作</td>
    </tr>
    <tr>
      <td>build_all_zonelists</td>
      <td>建立结点和内存域的数据结构</td>
    </tr>
    <tr>
      <td>mem_init</td>
      <td>也是一个独立于体系结构的函数，用于停用bootmem分配器并迁移到实际的内存管理函数</td>
    </tr>
    <tr>
      <td>setup_per_cpu_pageset</td>
      <td>为pageset数组的第一个数组元素分配内存</td>
    </tr>
  </tbody>
</table>

<p>由于大部分函数实现都是体系结构相关的，所以不再详细的介绍。</p>

  </div>

  <div class="forb">
  
  <a href="http://guojing.me/linux-kernel-architecture/tags/#初始化">#初始化</a>
  
  <a href="http://guojing.me/linux-kernel-architecture/tags/#内存管理">#内存管理</a>
  
  </div>

  <div class="suggest">
    
        <a href="http://guojing.me/linux-kernel-architecture/posts/highmem/" class="pre">&lt; 高端内存页框的内核映射</a>
    
    
    
        <a href="http://guojing.me/linux-kernel-architecture/posts/interrupt/" class="next">中断和异常 &gt;</a>
    
    </div>
</div>

<!--
<div class="comments mm_manage内存管理_comments_css">
<div id="disqus_container"> 
    
    <a href="#" class="comment" onclick="return false;">点击评论或查看评论。</a>
        
    <div id="disqus_thread"></div>
</div>
</div>
-->

<script type="text/javascript">
    $(document).ready(function(){
        $('#disqus_container .comment').on('click',function(){
            $(this).html('加载中...');
    var disqus_shortname = 'jguoer';
            var that = this;
            BYB.includeScript('http://' + disqus_shortname + '.disqus.com/embed.js',function(){$(that).remove()});
        });
});
</script>

<!--
  Copryright GuoJing 未经允许，严禁直接从Github上转载我的文章，所有文章遵循CC协议，允许复制和转载，但需要保留原作者链接。
  该文章初始化内存管理写于2014年04月22日。
-->

</div>
<div class="footer">
<!--
    Copyright GuoJing, Theme designed by GuoJing
    Theme name Simple
    If you love this theme, please keep my copyright and link to my blog.
    If you DON'T LIKE it and you CAN remove the link. but not share spirit.
    如果你喜欢这个博客构架和皮肤，请保留我作为原作者的权利，我会感谢你。
    你也可以不保留我作为原作者的权利，自然没有任何问题，但似乎没有共享精神。
-->
<!-- © Copryright by<a href="http://guojing.me/" target="_blank">GuoJing</a> 2012-2014 using <a href="http://www.github.com/" target="_blank">GitHub</a> and <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> -->
<div class="author">
    <div class="icon">
        <img src="/images/authors/guojing.jpg" alt="me"/>
    </div>
    <div class="name">
        <a href="/about">GuoJing</a>
    </div>
    <div class="description">
        Linux Kernel Architecture 内核笔记
    </div>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42721249-1', 'guojing.me');
  ga('send', 'pageview');

</script>
</div>

</body>
</html>
