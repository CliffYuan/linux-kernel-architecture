<!DOCTYPE HTML>
<html>
<!-- <html> -->
<head>
  <title>动态分配IRQ线|Linux Kernel Architecture 内核笔记</title>
  <meta charset="utf-8" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/feed.xml">
<link rel="icon" href="/images/icons/avatar.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/style/css/bootstrap.css" type="text/css" media="screen">
<link rel="stylesheet" href="/style/css/syntax.css" type="text/css" media="screen">
<script type="text/javascript" src="/style/jquery-1.7.1.min.js"></script>


<link rel="stylesheet" href="/style/style.css" type="text/css">

<script>
$(document).ready(function(){
    $('.nav a').hover(
        function(){
            $(this).animate({opacity: 0.3}, 400)
        }, 
        function(){
            $(this).animate({opacity: 1}, 400)
        });
});
function getURLParameter(name) {
    return decodeURI(
        (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]
    );
}
</script>

<style>
.archive li {
    list-style: decimal;
    margin-left: 50px;
    line-height: 2em;
}

.archive .year {
    list-style: none;
}
</style>
  <script type="text/javascript">
        var BYB = {};
  </script>
  <script type="text/javascript">
    BYB.includeScript = function(file,callback){
    var _doc = document.getElementsByTagName('head')[0];
    var js = document.createElement('script');
    js.setAttribute('type', 'text/javascript');
    js.setAttribute('src', file);
    _doc.appendChild(js);
    
    if (!/*@cc_on!@*/0) { //if not IE
    //Firefox2、Firefox3、Safari3.1+、Opera9.6+ support js.onload
    js.onload = function () {
    callback();
    }
    } else {
    //IE6、IE7 support js.onreadystatechange
    js.onreadystatechange = function () {
    if (js.readyState == 'loaded' || js.readyState == 'complete') {
    callback();
    }
    }
    }
    return false;
    }
  </script>
  <meta content="linux kernel architecture 内核笔记 动态分配IRQ线..." name="description"/>
  <meta content="IRQ,动态分配," name="keywords"/>
  <meta property="og:type" content="article" />
  <meta property="og:url" content="http://guojing.me/linux-kernel-architecture//posts/io-interrupt-dynamic/" />
  <meta property="og:title" content="动态分配IRQ线" />
  <meta property="og:description" content="linux kernel architecture 内核笔记 动态分配IRQ线..." />
</head>
<body>

<div class="banner">
<ul class="nav nav-pills">
  <li><a href="/">daf94cf87</a></li>
  <!--
  I love bettylwx
    -->
</ul>
</div>

<div class="container">

<div class="main clearfix">
  <div class="title">动态分配IRQ线</div>

  <div class="content 中断和异常_content_css">
    <p>IRQ中除了几个向量留给特定的设备，其余的向量都被动态地分配，因此有一种方式下同一条IRQ线可以让几个硬件设备使用，即使这些设备不允许IRQ共享，技巧就是使这些硬件设备的活动串行化，以便一次只能有一个设备拥有这个IRQ线。</p>

<p>在激活一个准备利用IRQ线的设备之前，其相应的驱动程序调用<em>request_irq()</em>，这个函数建立一个新的<em>irqaction</em>描述符，并用参数值初始化它。然后调用<em>setup_irq()</em>函数把这个描述符插入到合适的IRQ链表。</p>

<p>如果<em>setuo_irq</em>返回一个出错码，设备驱动程序中止操作，这意味着IRQ线已由另一个设备所使用，而这个设备不允许中断共享。当设备操作结束后，使用<em>free_irq()</em>函数从IRQ连表中删除这个描述符，并释放相应的内存区。</p>

<p>假定一个程序想要访问<em>/dev/fd0</em>设备文件，这个设备文件对应于系统中的第一个软盘，程序要做到这点，可以通过直接访问<em>/dev/fd0</em>，也可以通过在系统上安装一个文件系统，通常IRQ6分配给软盘控制器，给定这个号，软盘驱动程序发出下列请求：</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="n">request_irq</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">floppy_interrupt</span><span class="p">,</span>
            <span class="n">SA_INTERRUPT</span><span class="o">|</span><span class="n">SA_SAMPLE_RDANDOM</span><span class="p">,</span>
            <span class="s">"floppy"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span></code></pre></div>

<p>可以看到，<em>floppy_interrupt()</em>中断服务例程必须以关中断的方式执行，并且不共享这个IRQ，设置SA_SAMPLE_RANDOM标志意味着对软盘的访问是内核用于产生随机数的一个较好的随机事件源。当软盘的操作被终止时，要么中止<em>/dev/fd0</em>的I/O操作，要么卸载这个文件系统。然后驱动程序就释放IRQ线。</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="n">free_irq</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span></code></pre></div>

<p>为了把一个<em>irqaction</em>描述符插入到适当的连表中，内核调用<em>setup_irq()</em>函数，传递给这个函数的参数为<em>irq_nr</em>和<em>new</em>，<em>irq_nr</em>就是IRQ号，<em>new</em>为刚刚分配的<em>irqaction</em>描述符。<em>setup_irq()</em>是体系结构相关的，所以了解一下这个函数做了什么。</p>

<ol>
  <li>检查另一个设备是否已经使用<em>irq_nr</em>这个IRQ，如果是，检查两个设备的irqaction描述符中的SA_SHIREQ标志是否都指定了IRQ线能被共享，否则就返回一个错误码。</li>
  <li>把*new加到链表中。</li>
  <li>如果没有其他设备共享同一个IRQ，清理相关的设置并调用irq_desc-&gt;handler PIC对象的<em>startup</em>方法以确保IRQ信号被激活。</li>
</ol>

  </div>

  <hr>
  <div class="eof">EOF</div>
  <hr>

  <div class="forb">
  
  <a href="http://guojing.me/linux-kernel-architecture/tags/#IRQ">#IRQ</a>
  
  <a href="http://guojing.me/linux-kernel-architecture/tags/#动态分配">#动态分配</a>
  
  </div>

  <div class="suggest">
    
        <a href="http://guojing.me/linux-kernel-architecture/posts/io-interrupt-and-data-struct/" class="pre">&lt; I/O中断处理</a>
    
    
    
        <a href="http://guojing.me/linux-kernel-architecture/posts/multi-cpu-interrupt/" class="next">处理器间中断处理 &gt;</a>
    
    </div>
</div>

<!--
<div class="comments 中断和异常_comments_css">
<div id="disqus_container"> 
    
    <a href="#" class="comment" onclick="return false;">点击评论或查看评论。</a>
        
    <div id="disqus_thread"></div>
</div>
</div>
-->

<script type="text/javascript">
    $(document).ready(function(){
        $('#disqus_container .comment').on('click',function(){
            $(this).html('加载中...');
    var disqus_shortname = 'jguoer';
            var that = this;
            BYB.includeScript('http://' + disqus_shortname + '.disqus.com/embed.js',function(){$(that).remove()});
        });
});
</script>

<!--
  Copryright GuoJing 未经允许，严禁直接从Github上转载我的文章，所有文章遵循CC协议，允许复制和转载，但需要保留原作者链接。
  该文章动态分配IRQ线写于2014年05月07日。
-->

</div>
<div class="footer">
<!--
    Copyright GuoJing, Theme designed by GuoJing
    Theme name Simple
    If you love this theme, please keep my copyright and link to my blog.
    If you DON'T LIKE it and you CAN remove the link. but not share spirit.
    如果你喜欢这个博客构架和皮肤，请保留我作为原作者的权利，我会感谢你。
    你也可以不保留我作为原作者的权利，自然没有任何问题，但似乎没有共享精神。
-->
<!-- © Copryright by<a href="http://guojing.me/" target="_blank">GuoJing</a> 2012-2014 using <a href="http://www.github.com/" target="_blank">GitHub</a> and <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42721249-1', 'guojing.me');
  ga('send', 'pageview');

</script>
</div>

</body>
</html>
