<!DOCTYPE HTML>
<html>
<!-- <html> -->
<head>
  <title>内核信号量|Linux Kernel Architecture 内核笔记</title>
  <meta charset="utf-8" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/feed.xml">
<link rel="icon" href="/images/icons/avatar.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/style/css/bootstrap.css" type="text/css" media="screen">
<link rel="stylesheet" href="/style/css/syntax.css" type="text/css" media="screen">
<script type="text/javascript" src="/style/jquery-1.7.1.min.js"></script>


<link rel="stylesheet" href="/style/style.css" type="text/css">

<script>
$(document).ready(function(){
    $('.nav a').hover(
        function(){
            $(this).animate({opacity: 0.3}, 400)
        }, 
        function(){
            $(this).animate({opacity: 1}, 400)
        });
});
function getURLParameter(name) {
    return decodeURI(
        (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]
    );
}
</script>

<style>
.archive li {
    list-style: decimal;
    margin-left: 50px;
    line-height: 2em;
}

.archive .year {
    list-style: none;
}
</style>
  <script type="text/javascript">
        var BYB = {};
  </script>
  <script type="text/javascript">
    BYB.includeScript = function(file,callback){
    var _doc = document.getElementsByTagName('head')[0];
    var js = document.createElement('script');
    js.setAttribute('type', 'text/javascript');
    js.setAttribute('src', file);
    _doc.appendChild(js);
    
    if (!/*@cc_on!@*/0) { //if not IE
    //Firefox2、Firefox3、Safari3.1+、Opera9.6+ support js.onload
    js.onload = function () {
    callback();
    }
    } else {
    //IE6、IE7 support js.onreadystatechange
    js.onreadystatechange = function () {
    if (js.readyState == 'loaded' || js.readyState == 'complete') {
    callback();
    }
    }
    }
    return false;
    }
  </script>
  <meta content="linux kernel architecture 内核笔记 内核信号量..." name="description"/>
  <meta content="内核信号量,信号量," name="keywords"/>
  <meta property="og:type" content="article" />
  <meta property="og:url" content="http://guojing.me/linux-kernel-architecture//posts/kernel-semaphore/" />
  <meta property="og:title" content="内核信号量" />
  <meta property="og:description" content="linux kernel architecture 内核笔记 内核信号量..." />
</head>
<body>

<div class="banner">
<ul class="nav nav-pills">
  <li><a href="/">daf94cf87</a></li>
  <!--
  I love bettylwx
    -->
</ul>
</div>

<div class="container">

<div class="main clearfix">
  <div class="title">内核信号量</div>

  <div class="content 内核同步_content_css">
    <p>内核信号量类似于自旋锁，因为当锁关闭着，它不允许内核控制路径继续执行，然而，当内核控制路径试图获取内核信号量所保护的忙资源时，相应的进程被挂起，只有在资源被释放时，进程才再次变为可运行状态。因此，只有可以睡眠的函数才能获取内核信号量，中断处理程序和可延迟函数都不能使用内核信号量。</p>

<p>内核信号量是<em>semaphore</em>类型的对象，代码如下：</p>

<h4 id="includelinuxsemaphoreh">&lt;include/linux/semaphore.h&gt;</h4>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="k">struct</span> <span class="n">semaphore</span> <span class="p">{</span>
    <span class="n">spinlock_t</span>        <span class="n">lock</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>      <span class="n">count</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">list_head</span>  <span class="n">wait_list</span><span class="p">;</span>
<span class="p">};</span></code></pre></div>

<p>其中字段及其意义如下：</p>

<table class="table_center">
  <thead>
    <tr>
      <th>字段</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>count</td>
      <td>计数器，如果该值大于0，那么资源就是空闲的，也就是说该资源可以被使用，相反，如果count等于0，那么信号量是忙的。如果count的值等于负数，则资源是不可用的</td>
    </tr>
    <tr>
      <td>lock</td>
      <td>信号量的锁</td>
    </tr>
    <tr>
      <td>wait_list</td>
      <td>存放等待队列链表的地址，当前等待资源的所有睡眠进程都放在这个列表中，如果count大于0，那么等待队列就为空</td>
    </tr>
  </tbody>
</table>

<h4 id="includelinuxsemaphoreh-1">&lt;include/linux/semaphore.h&gt;</h4>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#define init_MUTEX(sem)         sema_init(sem, 1)
#define init_MUTEX_LOCKED(sem)  sema_init(sem, 0)</span></code></pre></div>

<p>可以使用<em>init_MUTEX()</em>和<em>init_MUTEX_LOCKED()</em>宏来初始化互斥访问所需的信号量，这两个宏分别把<em>count</em>的值设置为1和0.其中1表示互斥访问的资源空闲，0表示对信号量进行初始化的进程当前互斥访问的资源忙。宏<em>DECLARE_MUTEX</em>用于静态的分配<em>semaphore</em>结构的变量。</p>

<h4 id="includelinuxsemaphoreh-2">&lt;include/linux/semaphore.h&gt;</h4>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#define DECLARE_MUTEX(name)
</span>    <span class="k">struct</span> <span class="n">semaphore</span> <span class="n">name</span> <span class="o">=</span> <span class="n">__SEMAPHORE_INITIALIZER</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></code></pre></div>

  </div>

  <div class="forb">
  
  <a href="http://guojing.me/linux-kernel-architecture/tags/#内核信号量">#内核信号量</a>
  
  <a href="http://guojing.me/linux-kernel-architecture/tags/#信号量">#信号量</a>
  
  </div>

  <div class="suggest">
    
        <a href="http://guojing.me/linux-kernel-architecture/posts/working-on-exception/" class="pre">&lt; 异常处理</a>
    
    
    
        <a href="http://guojing.me/linux-kernel-architecture/posts/vmalloc/" class="next">不连续页的分配 &gt;</a>
    
    </div>
</div>

<!--
<div class="comments 内核同步_comments_css">
<div id="disqus_container"> 
    
    <a href="#" class="comment" onclick="return false;">点击评论或查看评论。</a>
        
    <div id="disqus_thread"></div>
</div>
</div>
-->

<script type="text/javascript">
    $(document).ready(function(){
        $('#disqus_container .comment').on('click',function(){
            $(this).html('加载中...');
    var disqus_shortname = 'jguoer';
            var that = this;
            BYB.includeScript('http://' + disqus_shortname + '.disqus.com/embed.js',function(){$(that).remove()});
        });
});
</script>

<!--
  Copryright GuoJing 未经允许，严禁直接从Github上转载我的文章，所有文章遵循CC协议，允许复制和转载，但需要保留原作者链接。
  该文章内核信号量写于2014年05月06日。
-->

</div>
<div class="footer">
<!--
    Copyright GuoJing, Theme designed by GuoJing
    Theme name Simple
    If you love this theme, please keep my copyright and link to my blog.
    If you DON'T LIKE it and you CAN remove the link. but not share spirit.
    如果你喜欢这个博客构架和皮肤，请保留我作为原作者的权利，我会感谢你。
    你也可以不保留我作为原作者的权利，自然没有任何问题，但似乎没有共享精神。
-->
<!-- © Copryright by<a href="http://guojing.me/" target="_blank">GuoJing</a> 2012-2014 using <a href="http://www.github.com/" target="_blank">GitHub</a> and <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> -->
<div class="author">
    <div class="icon">
        <img src="/images/authors/guojing.jpg" alt="me"/>
    </div>
    <div class="name">
        <a href="/about">GuoJing</a>
    </div>
    <div class="description">
        Linux Kernel Architecture 内核笔记
    </div>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42721249-1', 'guojing.me');
  ga('send', 'pageview');

</script>
</div>

</body>
</html>
