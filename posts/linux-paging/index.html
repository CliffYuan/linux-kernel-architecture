<!DOCTYPE HTML>
<html>
<!-- <html> -->
<head>
  <title>Linux中的分页|Linux Kernel Architecture 内核笔记</title>
  <meta charset="utf-8" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/feed.xml">
<link rel="icon" href="/images/icons/avatar.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/style/css/bootstrap.css" type="text/css" media="screen">
<link rel="stylesheet" href="/style/css/syntax.css" type="text/css" media="screen">
<script type="text/javascript" src="/style/jquery-1.7.1.min.js"></script>


<link rel="stylesheet" href="/style/style.css" type="text/css">

<script>
$(document).ready(function(){
    $('.nav a').hover(
        function(){
            $(this).animate({opacity: 0.3}, 400)
        }, 
        function(){
            $(this).animate({opacity: 1}, 400)
        });
});
function getURLParameter(name) {
    return decodeURI(
        (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]
    );
}
</script>

<style>
.archive li {
    list-style: decimal;
    margin-left: 50px;
    line-height: 2em;
}

.archive .year {
    list-style: none;
}
</style>
  <script type="text/javascript">
        var BYB = {};
  </script>
  <script type="text/javascript">
    BYB.includeScript = function(file,callback){
    var _doc = document.getElementsByTagName('head')[0];
    var js = document.createElement('script');
    js.setAttribute('type', 'text/javascript');
    js.setAttribute('src', file);
    _doc.appendChild(js);
    
    if (!/*@cc_on!@*/0) { //if not IE
    //Firefox2、Firefox3、Safari3.1+、Opera9.6+ support js.onload
    js.onload = function () {
    callback();
    }
    } else {
    //IE6、IE7 support js.onreadystatechange
    js.onreadystatechange = function () {
    if (js.readyState == 'loaded' || js.readyState == 'complete') {
    callback();
    }
    }
    }
    return false;
    }
  </script>
  <meta content="linux kernel architecture 内核笔记 Linux中的分页..." name="description"/>
  <meta content="分页,页目录,页目录指针表,PDPT," name="keywords"/>
  <meta property="og:type" content="article" />
  <meta property="og:url" content="http://guojing.me/linux-kernel-architecture//posts/linux-paging/" />
  <meta property="og:title" content="Linux中的分页" />
  <meta property="og:description" content="linux kernel architecture 内核笔记 Linux中的分页..." />
</head>
<body>

<div class="banner">
<ul class="nav nav-pills">
  <li><a href="/" class="glyphicon glyphicon-inbox"> Home</a></li>
  <li><a href="/archive" class="glyphicon glyphicon-floppy-disk"> Archive</a></li>
  <li><a href="/linux-kernel-architecture/archive/" class="glyphicon glyphicon-book"> Kernel</a></li>
  <li><a href="/about" class="glyphicon glyphicon-record"> About</a></li>
</ul>
</div>

<div class="container">

<div class="main clearfix">
  <div class="title">Linux中的分页</div>

  <div class="content 内存寻址_content_css">
    <p>Linux采用了一种兼容32位和64位系统的普通分页模型。在32位系统模型中，两级分页已经足够了，但在64位系统中需要更多的分页级别。直到2.6.10版本，Linux采用三级分页模型，从2.6.11之后，采用了四级分页模型<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>。这4种页表分别为：</p>

<ol>
  <li>页全局目录（Page Global Directory）</li>
  <li>页上级目录（Page Upper Directory）</li>
  <li>页中间目录（Page Middle Directory）</li>
  <li>页表（Page Table）</li>
</ol>

<p>页全局目录包含若干页上级目录的地址，页上级目录又包含页中间目录的地址，依次类推，页中间目录则包含页表的目录地址。而每个页表指向一个页框。线性地址因此被划分成五个部分。下图的线性地址并没有显示位数，因为每一部分的大小跟具体的计算机体系结构相关。</p>

<p class="center"><img src="/linux-kernel-architecture/images/linux-paging.png" alt="system" style="max-width:700px" /></p>

<p class="center">Linux中的分页</p>

<p>上图显示了一个Linux的四级分页中是如何通过页目录找到页表然后寻址到相应的页。实际上，和之前两级分页的概念一样。针对32位系统。Linux取消了上级页目录和中间页目录字段。不过，页上级目录和页中间目录在指针中的位置被保留，以便同样的代码在32位系统和64位系统下都能使用。</p>

<p>内核位页上级目录和页中间目录保留了一个位置，这是通过它们的页目录项数设置位1，并把这两个目录项映射到页全局目录的一个适当的目录项而实现的。</p>

<p>启用了物理地址扩展的32位系统使用了三级页表，Linux的全局页目录对应80x86的页目录指针表（<em>PDPT</em>），取消了页上级目录，页中间目录对应80x86的页目录，Linux的页表对应80x86的页表。</p>

<p>最后，64位系统使用三级还是四级目录取决于硬件对线性地址的划分。</p>

<p>Linux的进程处理依赖于分页，实际上，线性地址到物理地址的自动转换使得下面的设计目标得以实现：</p>

<ol>
  <li>给每一个进程分配一块不同的物理地址空间，确保了可以有效地防止寻址错误。</li>
  <li>区别页和页框<sup id="fnref:page"><a href="#fn:page" class="footnote">2</a></sup>的不同，就允许存放在某个页框中的一个页，然后保存到磁盘上，以后重新装入这一页时又可以被装在不同的页框中。这是虚拟内存机制的基本要素。</li>
</ol>

<p>每一个进程有它自己的页全局目录和自己的页表集，当发生进程切换时，Linux把<em>cr3</em>寄存器的内容保存在前一个执行进程的描述符中，然后把下一个要执行进程的描述符的值装入到<em>cr3</em>寄存器中。因此当新进程重新开始在CPU上执行时，分页单元指向一组正确的页表。</p>

<p>线性地址字段，页表处理的函数和宏我就不列举了，可能在以后的（如果我深入了解内存管理的话）会再补充，这里只是笔记。</p>
<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>这个变化用来全力支持x86_64平台使用的对线性地址的划分。 <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:page">
      <p>页是一组数据，页框是主存的物理地址。 <a href="#fnref:page" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

  <div class="forb">
  
  <a href="http://guojing.me/linux-kernel-architecture/tags/#分页">#分页</a>
  
  <a href="http://guojing.me/linux-kernel-architecture/tags/#页目录">#页目录</a>
  
  <a href="http://guojing.me/linux-kernel-architecture/tags/#页目录指针表">#页目录指针表</a>
  
  <a href="http://guojing.me/linux-kernel-architecture/tags/#PDPT">#PDPT</a>
  
  </div>

  <div class="suggest">
    
        <a href="http://guojing.me/linux-kernel-architecture/posts/system-hardware-cache-and-tlb/" class="pre">&lt; 硬件高速缓存和TLB</a>
    
    
    
        <a href="http://guojing.me/linux-kernel-architecture/posts/page-and-page-descriptor/" class="next">页及其描述符 &gt;</a>
    
    </div>
</div>

<!--
<div class="comments 内存寻址_comments_css">
<div id="disqus_container"> 
    
    <a href="#" class="comment" onclick="return false;">点击评论或查看评论。</a>
        
    <div id="disqus_thread"></div>
</div>
</div>
-->

<script type="text/javascript">
    $(document).ready(function(){
        $('#disqus_container .comment').on('click',function(){
            $(this).html('加载中...');
    var disqus_shortname = 'jguoer';
            var that = this;
            BYB.includeScript('http://' + disqus_shortname + '.disqus.com/embed.js',function(){$(that).remove()});
        });
});
</script>

<!--
  Copryright GuoJing 未经允许，严禁直接从Github上转载我的文章，所有文章遵循CC协议，允许复制和转载，但需要保留原作者链接。
  该文章Linux中的分页写于2014年04月17日。
-->

</div>
<div class="footer">
<!--
    Copyright GuoJing, Theme designed by GuoJing
    Theme name Simple
    If you love this theme, please keep my copyright and link to my blog.
    If you DON'T LIKE it and you CAN remove the link. but not share spirit.
    如果你喜欢这个博客构架和皮肤，请保留我作为原作者的权利，我会感谢你。
    你也可以不保留我作为原作者的权利，自然没有任何问题，但似乎没有共享精神。
-->
<!-- © Copryright by<a href="http://guojing.me/" target="_blank">GuoJing</a> 2012-2014 using <a href="http://www.github.com/" target="_blank">GitHub</a> and <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> -->
<div class="author">
    <div class="icon">
        <img src="/images/authors/guojing.jpg" alt="me"/>
    </div>
    <div class="name">
        <a href="/about">GuoJing</a>
    </div>
    <div class="description">
        Linux Kernel Architecture 内核笔记
    </div>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42721249-1', 'guojing.me');
  ga('send', 'pageview');

</script>
</div>

</body>
</html>
