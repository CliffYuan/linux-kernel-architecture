<!DOCTYPE HTML>
<html>
<!-- <html> -->
<head>
  <title>处理程序的嵌套执行|Linux Kernel Architecture 内核笔记</title>
  <meta charset="utf-8" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/feed.xml">
<link rel="icon" href="/images/icons/avatar.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/style/css/bootstrap.css" type="text/css" media="screen">
<link rel="stylesheet" href="/style/css/syntax.css" type="text/css" media="screen">
<script type="text/javascript" src="/style/jquery-1.7.1.min.js"></script>


<link rel="stylesheet" href="/style/style.css" type="text/css">

<script>
$(document).ready(function(){
    $('.nav a').hover(
        function(){
            $(this).animate({opacity: 0.3}, 400)
        }, 
        function(){
            $(this).animate({opacity: 1}, 400)
        });
});
function getURLParameter(name) {
    return decodeURI(
        (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]
    );
}
</script>

<style>
.archive li {
    list-style: decimal;
    margin-left: 50px;
    line-height: 2em;
}

.archive .year {
    list-style: none;
}
</style>
  <script type="text/javascript">
        var BYB = {};
  </script>
  <script type="text/javascript">
    BYB.includeScript = function(file,callback){
    var _doc = document.getElementsByTagName('head')[0];
    var js = document.createElement('script');
    js.setAttribute('type', 'text/javascript');
    js.setAttribute('src', file);
    _doc.appendChild(js);
    
    if (!/*@cc_on!@*/0) { //if not IE
    //Firefox2、Firefox3、Safari3.1+、Opera9.6+ support js.onload
    js.onload = function () {
    callback();
    }
    } else {
    //IE6、IE7 support js.onreadystatechange
    js.onreadystatechange = function () {
    if (js.readyState == 'loaded' || js.readyState == 'complete') {
    callback();
    }
    }
    }
    return false;
    }
  </script>
  <meta content="linux kernel architecture 内核笔记 处理程序的嵌套执行..." name="description"/>
  <meta content="异常,中断,嵌套执行,内核控制路径," name="keywords"/>
  <meta property="og:type" content="article" />
  <meta property="og:url" content="http://guojing.me/linux-kernel-architecture//posts/loop-interrupt/" />
  <meta property="og:title" content="处理程序的嵌套执行" />
  <meta property="og:description" content="linux kernel architecture 内核笔记 处理程序的嵌套执行..." />
</head>
<body>

<div class="banner">
<ul class="nav nav-pills">
  <li><a href="/" class="glyphicon glyphicon-inbox"> Home</a></li>
  <li><a href="/archive" class="glyphicon glyphicon-floppy-disk"> Archive</a></li>
  <li><a href="/linux-kernel-architecture/archive/" class="glyphicon glyphicon-book"> Kernel</a></li>
  <li><a href="/about" class="glyphicon glyphicon-record"> About</a></li>
</ul>
</div>

<div class="container">

<div class="main clearfix">
  <div class="title">处理程序的嵌套执行</div>

  <div class="content 中断和异常_content_css">
    <p>每个中断或异常都会引起一个内核控制路径，或者说代表当前进程在内核态执行单独的指令序列。我们再来回顾一下什么是内核控制路径。内核控制路径（kernel control path）表示内核处理系统调用、异常或中断所执行的指令序列。所以，我们只要知道内核控制路径是一些指令序列即可。</p>

<p>当I/O设备发出一个中断时，相应的内核控制路径的第一部分指令就是那些把寄存器的内容保存在内核堆栈的指令，而最后一部分指令就是恢复寄存器内容并让CPU返回到用户态的哪些指令。</p>

<p>内核控制路径可以任意嵌套，一个中断处理程序可以被另一个中断处理程序『中断』，所以就会产生中断处理程序的嵌套执行，如下图：</p>

<p class="center"><img src="/linux-kernel-architecture/images/irq_loop.png" alt="IRQ" style="max-width:500px" /></p>

<p class="center">嵌套中断处理</p>

<p>如上图所示，当产生一个中断之后，进入内核态的一个中断处理程序。中断处理程序被另外一个中断给『中断』，于是进入第二个中断处理程序。当第二个中断处理程序处理完毕后，返回第一个中断处理程序，第一个中断处理程序处理完毕后，返回用户态进程。</p>

<p>允许内核控制路径嵌套必须有特定的规定，那就是中断处理程序必须永不阻塞，事实上，异常要么是由编程错误引起的，要么是由调试程序触发的，然而缺页异常发生在内核态。这发生在当进程试图对属于其他地址空间的页进行寻址，而这个页现在不在RAM中时。</p>

<p>当处理这样一个异常时，内核可以挂起当前进程，并用另一个进程替代它，知道请求的页可以使用位置，只要被挂起的进程又获得处理器，处理缺页异常的内核控制路径就恢复执行。因为缺页异常从不引起另一个异常，所以与异常相关的至多两个内核控制路径会堆叠在一起。</p>

<p>与异常形成对照的时，尽管中断的内核控制路径代表当前进程运行，但由I/O设备产生的中断并不引用当前进程的数据结构，实际上，当一个给定的中断发生时，要预测哪个进程即将运行是不可能的。</p>

<p>一个中断处理程序既可以抢占其他的中断处理程序，页可以抢占异常处理程序，相反，异常处理程序从不抢占中断处理程序，在内核态能触发的唯一异常就是缺页异常，但中断处理程序从不知心可以导致缺页的操作。</p>

<p>基于下面两个原因，Linux交错执行内核控制路径：</p>

<ol>
  <li>为了提高可编程中断控制器和设备控制器的吞吐量。假定设备控制器在一条IRQ线上产生了一个信号，PIC把这个信号转换成一个外部中断，然后PIC和设备控制器保持阻塞，一直到PIC从CPU处接受到一个条应答信息。由内核控制路径的交错执行，内核即使在处理前一个中断，也能发送应答。</li>
  <li>为了实现一个没有优先级的中断模型。因为每个中断处理程序都可以被另一个中断处理程序延缓，因此，硬件设备之间没必要建立预定义优先级，这就简化了代码，提高了内核的可移植性。</li>
</ol>

<p>在多处理器系统上，几个内核控制路径可以并发执行，此外，与异常相关的内核控制路径可以开始在一个CPU上执行，并且由于进程切换而迁移到另一个CPU上执行。</p>

  </div>

  <div class="forb">
  
  <a href="http://guojing.me/linux-kernel-architecture/tags/#异常">#异常</a>
  
  <a href="http://guojing.me/linux-kernel-architecture/tags/#中断">#中断</a>
  
  <a href="http://guojing.me/linux-kernel-architecture/tags/#嵌套执行">#嵌套执行</a>
  
  <a href="http://guojing.me/linux-kernel-architecture/tags/#内核控制路径">#内核控制路径</a>
  
  </div>

  <div class="suggest">
    
        <a href="http://guojing.me/linux-kernel-architecture/posts/seqlock/" class="pre">&lt; 顺序锁</a>
    
    
    
        <a href="http://guojing.me/linux-kernel-architecture/posts/mm-release/" class="next">释放页 &gt;</a>
    
    </div>
</div>

<!--
<div class="comments 中断和异常_comments_css">
<div id="disqus_container"> 
    
    <a href="#" class="comment" onclick="return false;">点击评论或查看评论。</a>
        
    <div id="disqus_thread"></div>
</div>
</div>
-->

<script type="text/javascript">
    $(document).ready(function(){
        $('#disqus_container .comment').on('click',function(){
            $(this).html('加载中...');
    var disqus_shortname = 'jguoer';
            var that = this;
            BYB.includeScript('http://' + disqus_shortname + '.disqus.com/embed.js',function(){$(that).remove()});
        });
});
</script>

<!--
  Copryright GuoJing 未经允许，严禁直接从Github上转载我的文章，所有文章遵循CC协议，允许复制和转载，但需要保留原作者链接。
  该文章处理程序的嵌套执行写于2014年05月05日。
-->

</div>
<div class="footer">
<!--
    Copyright GuoJing, Theme designed by GuoJing
    Theme name Simple
    If you love this theme, please keep my copyright and link to my blog.
    If you DON'T LIKE it and you CAN remove the link. but not share spirit.
    如果你喜欢这个博客构架和皮肤，请保留我作为原作者的权利，我会感谢你。
    你也可以不保留我作为原作者的权利，自然没有任何问题，但似乎没有共享精神。
-->
<!-- © Copryright by<a href="http://guojing.me/" target="_blank">GuoJing</a> 2012-2014 using <a href="http://www.github.com/" target="_blank">GitHub</a> and <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> -->
<div class="author">
    <div class="icon">
        <img src="/images/authors/guojing.jpg" alt="me"/>
    </div>
    <div class="name">
        <a href="/about">GuoJing</a>
    </div>
    <div class="description">
        Linux Kernel Architecture 内核笔记
    </div>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42721249-1', 'guojing.me');
  ga('send', 'pageview');

</script>
</div>

</body>
</html>
