<!DOCTYPE HTML>
<html>
<!-- <html> -->
<head>
  <title>优化和内存屏障|Linux Kernel Architecture 内核笔记</title>
  <meta charset="utf-8" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/feed.xml">
<link rel="icon" href="/images/icons/avatar.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/style/css/bootstrap.css" type="text/css" media="screen">
<link rel="stylesheet" href="/style/css/syntax.css" type="text/css" media="screen">
<script type="text/javascript" src="/style/jquery-1.7.1.min.js"></script>


<link rel="stylesheet" href="/style/style.css" type="text/css">

<script>
$(document).ready(function(){
    $('.nav a').hover(
        function(){
            $(this).animate({opacity: 0.3}, 400)
        }, 
        function(){
            $(this).animate({opacity: 1}, 400)
        });
});
function getURLParameter(name) {
    return decodeURI(
        (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]
    );
}
</script>

<style>
.archive li {
    list-style: decimal;
    margin-left: 50px;
    line-height: 2em;
}

.archive .year {
    list-style: none;
}
</style>
  <script type="text/javascript">
        var BYB = {};
  </script>
  <script type="text/javascript">
    BYB.includeScript = function(file,callback){
    var _doc = document.getElementsByTagName('head')[0];
    var js = document.createElement('script');
    js.setAttribute('type', 'text/javascript');
    js.setAttribute('src', file);
    _doc.appendChild(js);
    
    if (!/*@cc_on!@*/0) { //if not IE
    //Firefox2、Firefox3、Safari3.1+、Opera9.6+ support js.onload
    js.onload = function () {
    callback();
    }
    } else {
    //IE6、IE7 support js.onreadystatechange
    js.onreadystatechange = function () {
    if (js.readyState == 'loaded' || js.readyState == 'complete') {
    callback();
    }
    }
    }
    return false;
    }
  </script>
  <meta content="linux kernel architecture 内核笔记 优化和内存屏障..." name="description"/>
  <meta content="内存屏障," name="keywords"/>
  <meta property="og:type" content="article" />
  <meta property="og:url" content="http://guojing.me/linux-kernel-architecture//posts/memory-barrier/" />
  <meta property="og:title" content="优化和内存屏障" />
  <meta property="og:description" content="linux kernel architecture 内核笔记 优化和内存屏障..." />
</head>
<body>

<div class="banner">
<ul class="nav nav-pills">
  <li><a href="/" class="glyphicon glyphicon-inbox"> Home</a></li>
  <li><a href="/archive" class="glyphicon glyphicon-floppy-disk"> Archive</a></li>
  <li><a href="/linux-kernel-architecture/archive/" class="glyphicon glyphicon-book"> Kernel</a></li>
  <li><a href="/about" class="glyphicon glyphicon-record"> About</a></li>
</ul>
</div>

<div class="container">

<div class="main clearfix">
  <div class="title">优化和内存屏障</div>

  <div class="content 内核同步_content_css">
    <p>当使用优化的编译器时，我们的指令有时候并不会严格按照它们再源代码中出现的顺序执行，因为编译器可能重新安排汇编语言指令以另寄存器以最优化的方式使用。此外，现代的CPU通常并行地执行若干条指令，且可能重新安排内存访问，这种重新安排可以极大地加速程序的执行。</p>

<p>当然，当处理器同步时，必须避免指令的重新排序，如果放在同步语句之后的一条指令再同步语句本身执行之前，就会出现失控，事实上，所有的同步原语起优化和内存屏障的作用。</p>

<p>优化屏障（<em>optimization barrier</em>）保证编译程序不会混淆放在原语操作之前的汇编语言指令和放在原语操作之后的汇编语言指令，这些汇编语言指令在C中都有对应的语句。再Linux中，优化屏障就是<em>barrier()</em>宏，它展开为<em>asm volatile(“”:::”memory”)</em>。指令<em>asm</em>高速编译程序要插入汇编语言的片段。<em>volatile</em>关键字禁止编译器把<em>asm</em>指令与程序中的其他指令重新组合排序。<em>memory</em>关键字强制编译器假定RAM中的所有内存单元已经被汇编语言指令修改，因此，编译器不能使用存放在CPU寄存器中的内存单元的值来优化<em>asm</em>指令前的代码。不过值得注意的是，优化屏障并不保证不使当前的CPU把汇编语言指令混在一起执行。</p>

<p>内存屏障（<em>memory barrier</em>）确保，再此之后的操作开始执行之前，操作已经完成，因此，内存屏障类似于防火墙，可以让任何汇编语言指令都无法通过。再80x86处理器中，下列种类的汇编语言指令是『串行的』，因为它们起内存屏障的作用：</p>

<ol>
  <li>对I/O端口进行操作的所有指令。</li>
  <li>有<em>lock</em>前缀的所有指令。</li>
  <li>写控制寄存器、系统寄存器或调试寄存器的所有指令。</li>
  <li>一些特别的汇编语言指令例如<em>lfence</em>、<em>sfence</em>和<em>mfence</em>等等。</li>
  <li>少数专门的汇编语言指令，例如终止中断处理程序或异常处理程序的iret指令。</li>
</ol>

<p>Linux使用六个内存屏障原语，这些原语也被当作优化屏障，因为我们必须保证编译程序不在屏障前后移动汇编语言指令。『读内存屏障』仅仅作用域从内村读指令，而『写内存品质』仅仅作用域写内存的指令。</p>

<p>内存屏障既用于多处理器系统也同样适用于单处理器系统，当内存屏障应该防止仅出现于多处理器系统上的竞争条件时，就使用<em>smp_xxx()</em>，在单处理器系统上，它们什么也不做，其他的内存屏障防止出现再单处理器和多处理器系统上的竞争条件。</p>

<p>这些内存屏障包括：</p>

<table class="table_center">
  <thead>
    <tr>
      <th>宏</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>mb()</td>
      <td>适用于MP和UP的内存屏障</td>
    </tr>
    <tr>
      <td>rmb()</td>
      <td>适用于MP和UP的读内存屏障</td>
    </tr>
    <tr>
      <td>wmb()</td>
      <td>适用于MP和UP的写内存屏障</td>
    </tr>
    <tr>
      <td>smp_mb()</td>
      <td>仅适用于MP的内存屏障</td>
    </tr>
    <tr>
      <td>smp_rmb()</td>
      <td>仅适用于MP的读内存屏障</td>
    </tr>
    <tr>
      <td>smp_wmb()</td>
      <td>仅适用于MP的写内存屏障</td>
    </tr>
  </tbody>
</table>

  </div>

  <div class="forb">
  
  <a href="http://guojing.me/linux-kernel-architecture/tags/#内存屏障">#内存屏障</a>
  
  </div>

  <div class="suggest">
    
        <a href="http://guojing.me/linux-kernel-architecture/posts/time-system/" class="pre">&lt; 时钟和定时器电路</a>
    
    
    
        <a href="http://guojing.me/linux-kernel-architecture/posts/timing-in-linux/" class="next">Linux计时体系结构 &gt;</a>
    
    </div>
</div>

<!--
<div class="comments 内核同步_comments_css">
<div id="disqus_container"> 
    
    <a href="#" class="comment" onclick="return false;">点击评论或查看评论。</a>
        
    <div id="disqus_thread"></div>
</div>
</div>
-->

<script type="text/javascript">
    $(document).ready(function(){
        $('#disqus_container .comment').on('click',function(){
            $(this).html('加载中...');
    var disqus_shortname = 'jguoer';
            var that = this;
            BYB.includeScript('http://' + disqus_shortname + '.disqus.com/embed.js',function(){$(that).remove()});
        });
});
</script>

<!--
  Copryright GuoJing 未经允许，严禁直接从Github上转载我的文章，所有文章遵循CC协议，允许复制和转载，但需要保留原作者链接。
  该文章优化和内存屏障写于2014年04月29日。
-->

</div>
<div class="footer">
<!--
    Copyright GuoJing, Theme designed by GuoJing
    Theme name Simple
    If you love this theme, please keep my copyright and link to my blog.
    If you DON'T LIKE it and you CAN remove the link. but not share spirit.
    如果你喜欢这个博客构架和皮肤，请保留我作为原作者的权利，我会感谢你。
    你也可以不保留我作为原作者的权利，自然没有任何问题，但似乎没有共享精神。
-->
<!-- © Copryright by<a href="http://guojing.me/" target="_blank">GuoJing</a> 2012-2014 using <a href="http://www.github.com/" target="_blank">GitHub</a> and <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> -->
<div class="author">
    <div class="icon">
        <img src="/images/authors/guojing.jpg" alt="me"/>
    </div>
    <div class="name">
        <a href="/about">GuoJing</a>
    </div>
    <div class="description">
        Linux Kernel Architecture 内核笔记
    </div>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42721249-1', 'guojing.me');
  ga('send', 'pageview');

</script>
</div>

</body>
</html>
