<!DOCTYPE HTML>
<html>
<!-- <html> -->
<head>
  <title>扩展分页PAE机制|Linux Kernel Architecture 内核笔记</title>
  <meta charset="utf-8" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/feed.xml">
<link rel="icon" href="/images/icons/avatar.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/style/css/bootstrap.css" type="text/css" media="screen">
<link rel="stylesheet" href="/style/css/syntax.css" type="text/css" media="screen">
<script type="text/javascript" src="/style/jquery-1.7.1.min.js"></script>


<link rel="stylesheet" href="/style/style.css" type="text/css">

<script>
$(document).ready(function(){
    $('.nav a').hover(
        function(){
            $(this).animate({opacity: 0.3}, 400)
        }, 
        function(){
            $(this).animate({opacity: 1}, 400)
        });
});
function getURLParameter(name) {
    return decodeURI(
        (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]
    );
}
</script>

<style>
.archive li {
    list-style: decimal;
    margin-left: 50px;
    line-height: 2em;
}

.archive .year {
    list-style: none;
}
</style>
  <script type="text/javascript">
        var BYB = {};
  </script>
  <script type="text/javascript">
    BYB.includeScript = function(file,callback){
    var _doc = document.getElementsByTagName('head')[0];
    var js = document.createElement('script');
    js.setAttribute('type', 'text/javascript');
    js.setAttribute('src', file);
    _doc.appendChild(js);
    
    if (!/*@cc_on!@*/0) { //if not IE
    //Firefox2、Firefox3、Safari3.1+、Opera9.6+ support js.onload
    js.onload = function () {
    callback();
    }
    } else {
    //IE6、IE7 support js.onreadystatechange
    js.onreadystatechange = function () {
    if (js.readyState == 'loaded' || js.readyState == 'complete') {
    callback();
    }
    }
    }
    return false;
    }
  </script>
  <meta content="linux kernel architecture 内核笔记 物理地址扩展分页机制..." name="description"/>
  <meta content="物理地址扩展,PAE,分页,扩展分页," name="keywords"/>
  <meta property="og:type" content="article" />
  <meta property="og:url" content="http://guojing.me/linux-kernel-architecture//posts/pae/" />
  <meta property="og:title" content="扩展分页PAE机制" />
  <meta property="og:description" content="linux kernel architecture 内核笔记 物理地址扩展分页机制..." />
</head>
<body>

<div class="banner">
<ul class="nav nav-pills">
  <li><a href="/">daf94cf87</a></li>
  <!--
  I love bettylwx
    -->
</ul>
</div>

<div class="container">

<div class="main clearfix">
  <div class="title">扩展分页PAE机制</div>

  <div class="content 内存寻址_content_css">
    <p>处理器所支持的RAM容量受链接到地址总线上的地址管脚数限制。早起Intel处理器从80386到Pentium使用32位物理地址。从理论上讲，这样的系统上可以安装高达4GB的RAM，而实际上，由于用户进程线性地址空间的需要，内核不能直接对1GB以上的RAM进行寻址<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>。</p>

<p>然而，大型服务器需要大于4GB的RAM来同时运行上千的进程，实际上我们现在的很多计算机的RAM都可能超过这个量级。所有必须扩展32位的80x86结构所支持的RAM容量。实际上即便是使用32位操作系统模拟64位<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup>，也会遇到一些问题，例如高低两个32位的数据同步问题。</p>

<h3 id="section">物理地址扩展分页机制</h3>

<p>Intel通过在它的处理器上把管脚数从32增加到36已经满足了这些需求。从Pentium Pro开始，Intel所有的处理器现在的寻址能力达2^36=64GB.不过，只有引入一种新的分页机制把32位线性地址转换为36位物理地址才能使用所增加的物理地址。</p>

<p>从Pentium Pro处理器开始，Intel引入一种叫做物理地址扩展的机制（<em>Physical Address Extension，PAE</em>），另外一种叫页大小扩展（<em>Page Size Extension，PSE</em>），但Linux并没有采用这种机制。</p>

<p>通过设置<em>cr4</em>控制寄存起中的物理地址扩展（PAE）标志激活PAE。页目录项中的页大小标志<em>PS</em>启动用大尺寸页，在PAE启用时，大小位2MB。当启用了PAE机制之后，系统的分页机制也做了相应的改变：</p>

<p>64GB的RAM被分为2^24个页框，页表项的物理地址字段从20位扩展到了24位，因为PAE页表项必须包含12个标志位和24个物理地址位，总数之和位36，页表项大小从32位变为64位增加了以北，结果一个4KB的页表包含512个表项而不是1024个表项。</p>

<p>引入一个叫做页目录指针表（<em>Page Directory Pointer Table，PDPT</em>）的页表新级别，它由4个64位表项组成。</p>

<p><em>cr3</em>控制寄存器包含一个27位的页目录指针表（<em>PDPT</em>）基地址字段。因为PDPT存放在RAM的前4GB中，并在32字节的倍数上对齐，因此27位足以表示这种表的基地址。</p>

<p>把线性地址映射到4KB的页时，页目录项中的PS标志清0，32位线性地址按下列方式解释：</p>

<table class="table_center">
  <thead>
    <tr>
      <th>字段名</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>cr3</td>
      <td>指向一个PDPT</td>
    </tr>
    <tr>
      <td>cr3的31-30位</td>
      <td>指向PDPT中4个项中的一个</td>
    </tr>
    <tr>
      <td>cr3的29-21位</td>
      <td>指向页目录中512个项中的一个</td>
    </tr>
    <tr>
      <td>cr3的20-12位</td>
      <td>指向页表中512项中的一个</td>
    </tr>
    <tr>
      <td>cr3的11-0位</td>
      <td>4KB页中的偏移量</td>
    </tr>
  </tbody>
</table>

<p>当把线性地址隐射到2MB的页时，页目录项中的PS标志为1，32位线性地址按下列方式解释：</p>

<table class="table_center">
  <thead>
    <tr>
      <th>字段名</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>cr3</td>
      <td>指向一个PDPT</td>
    </tr>
    <tr>
      <td>cr3的31-30位</td>
      <td>指向PDPT中4个项中的一个</td>
    </tr>
    <tr>
      <td>cr3的29-21位</td>
      <td>指向页目录中512个项中的一个</td>
    </tr>
    <tr>
      <td>cr3的20-0位</td>
      <td>2MB页中的偏移量</td>
    </tr>
  </tbody>
</table>

<p>显然，PAE并没有扩大进程的线性地址空间，因为它只能处理物理地址，此外，只有内核能够修改进程的页表，所以用户态下运行的进程不能使用大于4GB的物理地址空间。另一方面，PAE允许内核使用高达64GB的RAM，从而显著增加了系统中的进程数量。</p>

<h3 id="section-1">64位系统中的分页</h3>

<p>32为处理器普遍采用两级分页<sup id="fnref:3"><a href="#fn:3" class="footnote">3</a></sup>，但是两级分页并不适用于64位计算机系统。</p>

<p>首先假设一个大小为4KB的标准页，因为1KB覆盖2^10个地址范围，4KB覆盖2^12个地址，所以offset字段时12位，这样线性地址就剩下52位分配给<em>Table</em>和<em>Directory</em>
字段。这样可寻址范围非常之大。</p>

<p>如果现在决定使用64位中的48位来寻址，这样寻址范围页可以寻址256T呃空间！如果剩下的48-12=36位将被分配给<em>Table</em>和<em>Directory</em>，如果决定给两个字段各18位，那么每个进程的页目录和页表都含有2^18个项，即256000个项。还是过于庞大。</p>

<p>由于这个原因，所有的64位处理器的硬件分页都使用了额外的分页级别，也就是说多级分页级别。使用的级别数量取决于处理器的类型。不再深入讨论。</p>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>这个笔记会在后面Linux的分页中记录。 <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>用两个32位地址模拟成64位扩展寻址范围。 <a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:3">
      <p>也有处理器引入三级分页并激活PAE机制，总之我们可以认为多级分页可以减少页表的数目，便于高效的管理。 <a href="#fnref:3" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

  <div class="forb">
  
  <a href="http://guojing.me/linux-kernel-architecture/tags/#物理地址扩展">#物理地址扩展</a>
  
  <a href="http://guojing.me/linux-kernel-architecture/tags/#PAE">#PAE</a>
  
  <a href="http://guojing.me/linux-kernel-architecture/tags/#分页">#分页</a>
  
  <a href="http://guojing.me/linux-kernel-architecture/tags/#扩展分页">#扩展分页</a>
  
  </div>

  <div class="suggest">
    
        <a href="http://guojing.me/linux-kernel-architecture/posts/system-paging-unit/" class="pre">&lt; 硬件中的分页</a>
    
    
    
        <a href="http://guojing.me/linux-kernel-architecture/posts/system-hardware-cache-and-tlb/" class="next">硬件高速缓存和TLB &gt;</a>
    
    </div>
</div>

<!--
<div class="comments 内存寻址_comments_css">
<div id="disqus_container"> 
    
    <a href="#" class="comment" onclick="return false;">点击评论或查看评论。</a>
        
    <div id="disqus_thread"></div>
</div>
</div>
-->

<script type="text/javascript">
    $(document).ready(function(){
        $('#disqus_container .comment').on('click',function(){
            $(this).html('加载中...');
    var disqus_shortname = 'jguoer';
            var that = this;
            BYB.includeScript('http://' + disqus_shortname + '.disqus.com/embed.js',function(){$(that).remove()});
        });
});
</script>

<!--
  Copryright GuoJing 未经允许，严禁直接从Github上转载我的文章，所有文章遵循CC协议，允许复制和转载，但需要保留原作者链接。
  该文章扩展分页PAE机制写于2014年04月16日。
-->

</div>
<div class="footer">
<!--
    Copyright GuoJing, Theme designed by GuoJing
    Theme name Simple
    If you love this theme, please keep my copyright and link to my blog.
    If you DON'T LIKE it and you CAN remove the link. but not share spirit.
    如果你喜欢这个博客构架和皮肤，请保留我作为原作者的权利，我会感谢你。
    你也可以不保留我作为原作者的权利，自然没有任何问题，但似乎没有共享精神。
-->
<!-- © Copryright by<a href="http://guojing.me/" target="_blank">GuoJing</a> 2012-2014 using <a href="http://www.github.com/" target="_blank">GitHub</a> and <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42721249-1', 'guojing.me');
  ga('send', 'pageview');

</script>
</div>

</body>
</html>
